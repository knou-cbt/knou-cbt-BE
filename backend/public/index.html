<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°©ì†¡ëŒ€ CBT ì‹œìŠ¤í…œ - í…ŒìŠ¤íŠ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #34495e;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        input, button, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input[type="text"], input[type="url"] {
            width: 100%;
            margin-bottom: 10px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #d5f4e6;
            color: #27ae60;
        }
        .error {
            background: #fadbd8;
            color: #e74c3c;
        }
        .list-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .list-item:hover {
            background: #f8f9fa;
        }
        .question {
            background: #fff;
            border: 2px solid #3498db;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        .choice {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .choice:hover {
            background: #e8f4f8;
        }
        .choice.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .loading {
            text-align: center;
            color: #7f8c8d;
            padding: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
            font-weight: 600;
        }
        .inline-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .inline-group input {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ ë°©ì†¡ëŒ€ CBT ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>

        <!-- 1. í¬ë¡¤ë§ -->
        <div class="section">
            <h2>1ï¸âƒ£ ì‹œí—˜ í¬ë¡¤ë§</h2>
            <label>ì‹œí—˜ URL (ì—¬ëŸ¬ ê°œëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„):</label>
            <textarea id="crawlUrl" rows="5" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;" placeholder="https://...&#10;https://...&#10;https://..."></textarea>
            <div class="inline-group">
                <button onclick="crawlExam()">í¬ë¡¤ë§ ì‹œì‘</button>
                <button onclick="crawlExam(true)">ì¬ì‹œë„ (forceRetry)</button>
            </div>
            <div id="crawlResult" class="result" style="display:none"></div>
        </div>

        <!-- 2. ê³¼ëª© ëª©ë¡ -->
        <div class="section">
            <h2>2ï¸âƒ£ ê³¼ëª© ëª©ë¡</h2>
            <label>ê²€ìƒ‰ì–´ (ì„ íƒ):</label>
            <input type="text" id="subjectSearch" placeholder="ê³¼ëª©ëª… ê²€ìƒ‰">
            <button onclick="loadSubjects()">ê³¼ëª© ëª©ë¡ ì¡°íšŒ</button>
            <div id="subjectList" class="result" style="display:none"></div>
        </div>

        <!-- 3. ì‹œí—˜ ëª©ë¡ -->
        <div class="section">
            <h2>3ï¸âƒ£ ì‹œí—˜ ëª©ë¡</h2>
            <div class="inline-group">
                <div style="flex: 1;">
                    <label>ê³¼ëª©ëª…:</label>
                    <input type="text" id="examSubject" placeholder="ì˜ˆ: ì‚¬íšŒë³µì§€">
                </div>
                <div style="flex: 1;">
                    <label>ì—°ë„:</label>
                    <input type="number" id="examYear" placeholder="ì˜ˆ: 2024">
                </div>
            </div>
            <div class="inline-group">
                <div style="flex: 1;">
                    <label>ì‹œí—˜ ìœ í˜•:</label>
                    <select id="examType" style="width: 100%;">
                        <option value="">ì „ì²´</option>
                        <option value="1">1í•™ê¸° ê¸°ë§</option>
                        <option value="2">2í•™ê¸° ê¸°ë§</option>
                        <option value="3">í•˜ê³„í•™ê¸°</option>
                        <option value="4">ë™ê³„í•™ê¸°</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <label>ì •ë ¬:</label>
                    <select id="examSort" style="width: 100%;">
                        <option value="latest">ìµœì‹ ìˆœ</option>
                        <option value="oldest">ì˜¤ë˜ëœìˆœ</option>
                        <option value="name">ê³¼ëª©ëª…ìˆœ</option>
                    </select>
                </div>
            </div>
            <button onclick="loadExams()">ì‹œí—˜ ì¡°íšŒ</button>
            <div id="examList" class="result" style="display:none"></div>
        </div>

        <!-- 4. ì‹œí—˜ í’€ê¸° -->
        <div class="section">
            <h2>4ï¸âƒ£ ì‹œí—˜ í’€ê¸°</h2>
            <label>ì‹œí—˜ ID:</label>
            <input type="text" id="examId" placeholder="ì‹œí—˜ ID ì…ë ¥">
            <div class="inline-group">
                <button onclick="loadExamQuestions('test')">í…ŒìŠ¤íŠ¸ ëª¨ë“œ</button>
                <button onclick="loadExamQuestions('study')">í•™ìŠµ ëª¨ë“œ</button>
            </div>
            <div id="examQuestions"></div>
        </div>

    </div>

    <script>
        const API_BASE = '/api';
        let currentAnswers = {};

        // 1. í¬ë¡¤ë§
        async function crawlExam(forceRetry = false) {
            const urlInput = document.getElementById('crawlUrl').value.trim();
            const resultDiv = document.getElementById('crawlResult');
            
            if (!urlInput) {
                alert('URLì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            // ì—¬ëŸ¬ URLì¸ì§€ í™•ì¸ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)
            const urls = urlInput.split('\n').map(u => u.trim()).filter(u => u);
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';

            if (urls.length === 1) {
                // ë‹¨ì¼ URL í¬ë¡¤ë§
                resultDiv.textContent = 'í¬ë¡¤ë§ ì¤‘...';

                try {
                    const response = await fetch(`${API_BASE}/crawl`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: urls[0], forceRetry })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        resultDiv.className = 'result success';
                        resultDiv.textContent = `âœ… ì„±ê³µ!\n\n` +
                            `ì‹œí—˜ ID: ${data.data.examId}\n` +
                            `ì œëª©: ${data.data.title}\n` +
                            `ë¬¸ì œ ìˆ˜: ${data.data.questionCount}`;
                    } else {
                        throw new Error(data.message || 'í¬ë¡¤ë§ ì‹¤íŒ¨');
                    }
                } catch (error) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ì‹¤íŒ¨\n\n${error.message}`;
                }
            } else {
                // ë‹¤ì¤‘ URL ë°°ì¹˜ í¬ë¡¤ë§
                resultDiv.textContent = `ë°°ì¹˜ í¬ë¡¤ë§ ì‹œì‘ (${urls.length}ê°œ)...\nì§„í–‰ ì¤‘...`;

                try {
                    const response = await fetch(`${API_BASE}/crawl/batch`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ urls, forceRetry })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        const { total, successful, failed, results, errors } = data.data;
                        
                        let output = `ğŸ“Š ë°°ì¹˜ í¬ë¡¤ë§ ì™„ë£Œ\n\n`;
                        output += `ì´ ${total}ê°œ | ì„±ê³µ ${successful}ê°œ | ì‹¤íŒ¨ ${failed}ê°œ\n\n`;
                        
                        if (results.length > 0) {
                            output += `âœ… ì„±ê³µí•œ í•­ëª©:\n`;
                            results.forEach((r, i) => {
                                output += `${i + 1}. ${r.data.title} (ID: ${r.data.examId})\n`;
                            });
                        }
                        
                        if (errors.length > 0) {
                            output += `\nâŒ ì‹¤íŒ¨í•œ í•­ëª©:\n`;
                            errors.forEach((e, i) => {
                                output += `${i + 1}. ${e.url}\n   ${e.error}\n`;
                            });
                        }

                        resultDiv.className = failed > 0 ? 'result' : 'result success';
                        resultDiv.textContent = output;
                    } else {
                        throw new Error(data.message || 'ë°°ì¹˜ í¬ë¡¤ë§ ì‹¤íŒ¨');
                    }
                } catch (error) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ì‹¤íŒ¨\n\n${error.message}`;
                }
            }
        }

        // 2. ê³¼ëª© ëª©ë¡
        async function loadSubjects() {
            const search = document.getElementById('subjectSearch').value;
            const resultDiv = document.getElementById('subjectList');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';

            try {
                const url = search 
                    ? `${API_BASE}/subjects?search=${encodeURIComponent(search)}`
                    : `${API_BASE}/subjects`;
                
                const response = await fetch(url);
                const data = await response.json();

                if (response.ok) {
                    const subjects = data.data.subjects;
                    if (subjects.length === 0) {
                        resultDiv.innerHTML = '<p>ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    } else {
                        resultDiv.innerHTML = '<div class="grid">' + subjects.map(subject => `
                            <div class="list-item" onclick="loadExamsBySubject(${subject.id})">
                                <strong>${subject.name}</strong><br>
                                <small>ì‹œí—˜ ${subject.examCount}ê°œ</small>
                            </div>
                        `).join('') + '</div>';
                    }
                } else {
                    throw new Error(data.message || 'ì¡°íšŒ ì‹¤íŒ¨');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ${error.message}`;
            }
        }

        // 3. ì‹œí—˜ ëª©ë¡
        async function loadExams(page = 1) {
            const resultDiv = document.getElementById('examList');
            const subject = document.getElementById('examSubject').value;
            const year = document.getElementById('examYear').value;
            const examType = document.getElementById('examType').value;
            const sort = document.getElementById('examSort').value;
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';

            try {
                const params = new URLSearchParams();
                if (subject) params.append('subject', subject);
                if (year) params.append('year', year);
                if (examType) params.append('examType', examType);
                if (sort) params.append('sort', sort);
                params.append('page', page.toString());
                params.append('limit', '10');

                const response = await fetch(`${API_BASE}/exams?${params}`);
                const data = await response.json();

                if (response.ok) {
                    const exams = data.data;
                    const pagination = data.pagination;

                    if (exams.length === 0) {
                        resultDiv.innerHTML = '<p>ì‹œí—˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    } else {
                        let html = '<div class="grid">' + exams.map(exam => `
                            <div class="list-item" onclick="document.getElementById('examId').value=${exam.id}; window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });">
                                <strong>${exam.title}</strong><br>
                                <small>ID: ${exam.id} | ë¬¸ì œ: ${exam.totalQuestions}ê°œ</small><br>
                                <small style="color: #7f8c8d;">${exam.year}ë…„ ${getExamTypeText(exam.examType)}</small>
                            </div>
                        `).join('') + '</div>';

                        // í˜ì´ì§€ë„¤ì´ì…˜
                        if (pagination.totalPages > 1) {
                            html += '<div style="margin-top: 20px; text-align: center;">';
                            html += `<p>í˜ì´ì§€ ${pagination.page} / ${pagination.totalPages} (ì´ ${pagination.total}ê°œ)</p>`;
                            html += '<div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">';
                            
                            if (pagination.page > 1) {
                                html += `<button onclick="loadExams(${pagination.page - 1})">ì´ì „</button>`;
                            }
                            
                            // í˜ì´ì§€ ë²ˆí˜¸ (ìµœëŒ€ 5ê°œ)
                            const startPage = Math.max(1, pagination.page - 2);
                            const endPage = Math.min(pagination.totalPages, pagination.page + 2);
                            
                            for (let i = startPage; i <= endPage; i++) {
                                const active = i === pagination.page ? 'style="background: #2980b9;"' : '';
                                html += `<button onclick="loadExams(${i})" ${active}>${i}</button>`;
                            }
                            
                            if (pagination.page < pagination.totalPages) {
                                html += `<button onclick="loadExams(${pagination.page + 1})">ë‹¤ìŒ</button>`;
                            }
                            
                            html += '</div></div>';
                        }

                        resultDiv.innerHTML = html;
                    }
                } else {
                    throw new Error(data.message || 'ì¡°íšŒ ì‹¤íŒ¨');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ${error.message}`;
            }
        }

        function getExamTypeText(type) {
            const types = {
                1: '1í•™ê¸° ê¸°ë§',
                2: '2í•™ê¸° ê¸°ë§',
                3: 'í•˜ê³„í•™ê¸°',
                4: 'ë™ê³„í•™ê¸°'
            };
            return types[type] || 'ê¸°íƒ€';
        }

        // ê³¼ëª©ë³„ ì‹œí—˜ ëª©ë¡
        async function loadExamsBySubject(subjectId) {
            const resultDiv = document.getElementById('examList');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';

            try {
                const response = await fetch(`${API_BASE}/subjects/${subjectId}/exams`);
                const data = await response.json();

                if (response.ok) {
                    const exams = data.data;
                    if (exams.length === 0) {
                        resultDiv.innerHTML = '<p>ì‹œí—˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    } else {
                        resultDiv.innerHTML = '<div class="grid">' + exams.map(exam => `
                            <div class="list-item" onclick="document.getElementById('examId').value=${exam.id}">
                                <strong>${exam.title}</strong><br>
                                <small>ID: ${exam.id} | ë¬¸ì œ: ${exam.totalQuestions}ê°œ</small>
                            </div>
                        `).join('') + '</div>';
                    }
                    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                } else {
                    throw new Error(data.message || 'ì¡°íšŒ ì‹¤íŒ¨');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ${error.message}`;
            }
        }

        // 4. ì‹œí—˜ ë¬¸ì œ ì¡°íšŒ
        async function loadExamQuestions(mode) {
            const examId = document.getElementById('examId').value;
            const resultDiv = document.getElementById('examQuestions');
            
            if (!examId) {
                alert('ì‹œí—˜ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            resultDiv.innerHTML = '<div class="loading">ë¬¸ì œ ë¡œë”© ì¤‘...</div>';
            currentAnswers = {};

            try {
                const response = await fetch(`${API_BASE}/exams/${examId}/questions?mode=${mode}`);
                const data = await response.json();

                if (response.ok) {
                    const { exam, questions } = data.data;
                    
                    let html = `
                        <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h3>${exam.title}</h3>
                            <p>ì´ ${exam.totalQuestions}ë¬¸ì œ | ëª¨ë“œ: ${mode === 'study' ? 'í•™ìŠµ' : 'í…ŒìŠ¤íŠ¸'}</p>
                        </div>
                    `;

                    questions.forEach(q => {
                        html += `
                            <div class="question">
                                <strong>ë¬¸ì œ ${q.number}.</strong> ${q.text}
                                ${q.imageUrl ? `<br><img src="${q.imageUrl}" style="max-width: 100%; margin: 10px 0;">` : ''}
                                ${mode === 'study' && q.correctAnswer ? `<br><span style="color: #27ae60;">âœ“ ì •ë‹µ: ${q.correctAnswer}ë²ˆ</span>` : ''}
                                <div style="margin-top: 10px;">
                                    ${q.choices.map(choice => `
                                        <div class="choice" onclick="selectChoice(${q.id}, ${choice.number})" id="choice-${q.id}-${choice.number}">
                                            ${choice.number}. ${choice.text}
                                            ${mode === 'study' && choice.isCorrect ? ' âœ“' : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });

                    if (mode === 'test') {
                        html += `
                            <button onclick="submitExam(${examId})" style="width: 100%; padding: 15px; font-size: 16px;">
                                ë‹µì•ˆ ì œì¶œ ë° ì±„ì 
                            </button>
                        `;
                    }

                    resultDiv.innerHTML = html;
                } else {
                    throw new Error(data.message || 'ì¡°íšŒ ì‹¤íŒ¨');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ ${error.message}</div>`;
            }
        }

        function selectChoice(questionId, choiceNumber) {
            // ê°™ì€ ë¬¸ì œì˜ ë‹¤ë¥¸ ì„ íƒì§€ ì„ íƒ í•´ì œ
            document.querySelectorAll(`[id^="choice-${questionId}-"]`).forEach(el => {
                el.classList.remove('selected');
            });
            
            // ì„ íƒí•œ í•­ëª© í‘œì‹œ
            document.getElementById(`choice-${questionId}-${choiceNumber}`).classList.add('selected');
            
            // ë‹µì•ˆ ì €ì¥
            currentAnswers[questionId] = choiceNumber;
        }

        async function submitExam(examId) {
            if (Object.keys(currentAnswers).length === 0) {
                alert('ë‹µì•ˆì„ ì„ íƒí•˜ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/exams/${examId}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answers: currentAnswers })
                });

                const data = await response.json();

                if (response.ok) {
                    const result = data.data;
                    alert(`ì±„ì  ì™„ë£Œ!\n\n` +
                        `ì´ ë¬¸ì œ: ${result.totalQuestions}ë¬¸ì œ\n` +
                        `ì •ë‹µ: ${result.correctCount}ê°œ\n` +
                        `ì ìˆ˜: ${result.score}ì `);
                } else {
                    throw new Error(data.message || 'ì œì¶œ ì‹¤íŒ¨');
                }
            } catch (error) {
                alert(`âŒ ${error.message}`);
            }
        }
    </script>
</body>
</html>

